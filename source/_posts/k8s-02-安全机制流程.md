---
title: k8s-02-安全机制流程
date: 2018-08-05 19:25:10
tags: Kubernetes
---

#### 简述
Kubernetes集群的所有操作基本上都是通过kube-apiserver这个组件进行的，它提供HTTP RESTful形式的API供集群内外客户端调用。需要注意的是：认证授权过程只存在 https形式的API中。也就是说，如果客户端使用HTTP连接到kube-apiserver，那么是不会进行认证授权的，但默认只能在本机进行http访问。所以说，可以这么设置，在集群内部组件间通信使用http，集群外部就使用https，这样既增加了安全性，也不至于太复杂。

对kube-apiserver的访问要经过的三个步骤，前面两个是认证和授权，第三个是 Admission Control，它也能在一定程度上提高安全性，不过更多是资源管理方面的作用。认证解决用户是谁的问题，授权解决用户能做什么的问题。通俗的讲，认证就是验证用户名密码，授权就是检查该用户是否拥有权限访问请求的资源。通过合理的权限管理，能够保证系统的安全可靠。

#### 端口分类
kube-apiserver 默认在两个端口提供服务：
* 基于 https 的安全端口 6443
* 基于 http 的非安全端口 8080，仅本机连接


#### 安全控制步骤
对于安全端口来讲，一个 API 请求到达 6443 端口后，主要经过以下几步处理：

1. 认证
1. 授权
1. 准入控制
1. 实际的 API 请求

#### 1. 认证
kubernetes提供了多种认证方式，比如客户端证书、静态token、静态密码文件、ServiceAccountTokens等等。你可以同时使用一种或多种认证方式。只要通过任何一个都被认作是认证通过。下面我们就认识几个常见的认证方式。

#### 2. 授权
授权主要是用于对集群资源的访问控制，通过检查请求包含的相关属性值，与相对应的访问策略相比较，API请求必须满足某些策略才能被处理。

跟认证类似，Kubernetes也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；对于授权失败的请求则返回HTTP 403。



#### 3. 准入控制 / AdmissionControl 
AdmissionControl - 准入控制本质上为一段准入代码，在对kubernetes api的请求过程中，顺序为：先经过认证 & 授权，然后执行准入操作，最后对目标对象进行操作。这个准入代码在api-server中，而且必须被编译到二进制文件中才能被执行。 在对集群进行请求时，每个准入控制代码都按照一定顺序执行。如果有一个准入控制拒绝了此次请求，那么整个请求的结果将会立即返回，并提示用户相应的error信息。 