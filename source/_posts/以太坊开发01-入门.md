---
title: 以太坊开发01--入门
date: 2018-04-19 19:42:12
tags: BlockChain
---

### What?
以太坊(Ethereum)是一个建立在区块链技术之上，去中心化应用平台。它允许任何人在平台中建立和运行在区块链中的去中心化应用。

在没有以太坊之前，开发区块链应用是这样：拷贝一份比特币代码，然后去改底层代码中的加密算法、公示机制、网络协议等等（很多山寨币都是这样改出来的） 。

以太坊平台对底层区块链技术进行了封装，让区块链开发者可以基于此平台进行开发，开发者只用关注应用本身开发，从而大大降低开发难度。

### 智能合约
以太坊上的应用称为智能合约，它是代码和数据（状态）的集合。即可以理解为在区块链中可以自动执行的（由消息驱动的）、以代码形式编写的合同（特殊的交易）。

在比特币中，我们知道比特币的交易是可以编程的，但是比特币脚本有很多限制，而以太坊则更加完备（在计算机科学术语中称为图灵完备的），让我们就像使用任何高级语言一样来编写几乎可以作任何事情的程序（智能合约）。

智能合约非常适合对信任、安全和持久性要求较高的应用场景，比如：数字货币、数字资产、投票、保险、金融应用、预测市场、产权所有权管理、物联网、点对点交易等等。

目前除数字货币外，真正落地的应用还不多。

### 编程语言：Solidity
文件扩展名以.sol结尾。

官方推荐Solidity，用它来开发出合约，然后编译成以太坊虚拟机字节码。

> 此外还有Viper、Serpent、LLL及Bamboo

[Browser-Solidity](https://ethereum.github.io/browser-solidity/#optimize=false&version=soljson-v0.4.21+commit.dfe3193c.js)
是一个浏览器的Solidity IDE.

### 运行环境：EVM
EVM(Ethereum Virtual Machine)以太坊虚拟机是以太坊中的智能合约的运行环境。实质上是将用Solidity编写的源代码，编译成EVM可运行的字节码，字节码在EVM上执行。

EVM运行在以太坊机器节点上，当我们把合约部署到以太坊网络上之后，合约就可以在以太坊网络中运行了。

### 以太坊中的两类账户

和比特币使用UTXO的设计不一样，以太坊使用更为简单的账户概念，两类账户是对于EVM来说是一样的。

*  外部账户（EOA）

1. 有一个以太币余额；
1. 可以发送交易（以太币转账或者激活合约代码）；
1. 通过私钥控制；
1. 没有相关联的代码。

* 合约账户
1. 有一个以太币余额；
1. 有相关联的代码；
1. 代码执行是通过交易或者其他合约发送的call来激活；
1. 当被执行时 -- 运行在随机复杂度 （图灵完备性）-- 只能操作其拥有的特定储存，例如可以拥有其永久state -- 可以call其他合约.

两者区别：一个外部账户可以通过创建和用自己的私钥来对交易签名，来发送消息给另一个外部账户或合约账户。

在两个外部账户之间传送消息是价值转移的过程，但从外部账户到合约账户的消息会激活合约账户的代码，允许它执行各种动作（比如转移代币，写入内部存储，挖出一个新代币，执行一些运算，创建一个新合约等等）。只有当外部账户发出指令时，合约账户才会执行相应的操作。

### 计费机制：Gas
以太坊上用Gas机制来计费，Gas也可以认为是一个工作量单位，智能合约越复杂（计算步奏的数量和类型，占用的内存等），用来完成运行就需要越多Gas。

智能合约由区块链网络中的每个完整节点重复执行，使得合约执行的消耗变得昂贵，所以这也促使大家将能在链下进行的运算都不放到区块链上进行。对于每个被执行的命令都会有一个特定的消耗，用单位gas计数。每个合约可以利用的命令都会有一个相应的gas值。gas值的存在避免智能合约进入死循环，你不能编写永不结束的程序，因为你用尽了gas，计算将被节点拒绝。

在以太坊中，每笔交易都被要求包括一个gas limit和一个交易愿为单位gas支付的费用。矿工可以有选择的打包这些交易并收取这些费用。在现实中，由于矿工会优先选择打包费用高的交易，所以用户所选择支付的交易费用多少会影响到该交易被打包所需等待的时长。

1. 如果该交易由于计算，包括原始消息和一些触发的其他消息，需要使用的gas数量小于或等于所设置的gas limit，那么这个交易会被处理。

2. 如果gas总消耗超过gas limit，那么所有的操作都会被复原，但交易是成立的并且交易费任会被矿工收取。区块链会显示这笔交易完成尝试，但因为没有提供足够的gas导致所有的合约命令都被复原（out-of-gas）。

3. 所有交易里没有被使用的超量gas都会以以太币的形式打回给交易发起者。因为gas消耗一般只是一个大致估算，所以许多用户会超额支付gas来保证他们的交易会被接受。

当EVM执行交易时，Gas将按照特定规则被逐条消耗，无论执行到什么位置，一旦Gas被耗尽，将会触发异常。当前调用帧所做的所有状态修改都被回滚，如果执行结束还有Gas剩余，这些Gas将被返还给发送账户。如果没有这个限制，就会有人写出无法停止的合约来阻塞网络。

因此实际上，我们需要一个有以太币余额的外部账户，来发起一个交易（普通交易或部署、运行一个合约），运行时，矿工收取相应的工作量费用。

### 以太坊Dapp客户端
* go-ethereum
 
go-ethereum客户端通常被称为geth，基于Go语言开发,是目前用户最多，使用最广泛的客户端。通过Geth客户端与以太坊网络进行连接和交互可以实现账户管理、合约部署、挖矿等众多有趣且实用的功能。其中包含EVM.

* Mist

Mist是以太坊官方提供的图形化客户端。一个漂亮的界面来与以太坊节点交互，与智能合约发、收交易。

* MetaMask

MetaMask是一个Google浏览器扩展，把Chrome变成了一个DApp浏览器。它的核心特性是注入以太坊提供的js客户端库web3，到每一个界面，来让DApp连接到MetaMask提供的以太坊节点服务。不过这个Chrome扩展，可以允许你管理你的钱包，以及连接到不同的以太坊网络（包括本地的开发网络）。



### 合约的部署及运行

* 部署

智能合约的部署是将编译好的合约字节码通过外部账户发送交易的形式部署到以太坊区块链上，由实际矿工出块后，才真正部署成功。

* 运行

合约部署之后，当需要调用这个智能合约的方法时只需要向这个合约账户发送消息（交易）即可，通过消息触发后智能合约的代码就会在EVM中执行了。



### 创建以太坊私链
* Ganache

前身是testRPC，有两个版本，UI和cli

* truffle develop

truffle内置的客户端

### Dapp: 去中心化的应用程序
以太坊社区把基于智能合约的应用称为去中心化的应用程序（Decentralized App）。如果我们把区块链理解为一个不可篡改的数据库，智能合约理解为和数据打交道的程序，基于这个程序之上的为Dapp了，可能还包括一个友好的UI或其他东西。

### Truffle框架
Truffle是Dapp开发框架，他可以帮我们处理掉大量无关紧要的小事情，让我们可以迅速开始写代码-编译-部署-测试-打包Dapp这个流程。

[参考](https://juejin.im/post/5ad4887b6fb9a028d375e175#heading-19)