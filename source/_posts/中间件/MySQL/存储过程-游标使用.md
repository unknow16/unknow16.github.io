---
title: 存储过程-游标使用
date: 2018-08-27 19:09:30
tags: DB
---

## MySQL游标简介
游标的作用就是用于对查询数据库所返回的记录进行遍历，以便进行相应的操作；

游标有下面这些属性：
1. 游标是只读的，也就是不能更新它；
2. 游标是不能滚动的，也就是只能在一个方向上进行遍历，不能在记录之间随意进退，不能跳过某些记录；
3. 避免在已经打开游标的表上更新数据。

## Example
下面的游标使用演示获取库存量小于100的产品的代码code，这个代码纯粹演示如何使用，在这里没有其他任何意义.
```
DELIMITER $$  
  
DROP PROCEDURE IF EXISTS `test`.`CursorProc` $$  
CREATE PROCEDURE `test`.`CursorProc` ()  
BEGIN  
 DECLARE  no_more_products, quantity_in_stock INT DEFAULT 0;  
 DECLARE  prd_code VARCHAR(255);  
 DECLARE  cur_product CURSOR FOR   SELECT code FROM products;  /*First: Delcare a cursor,首先这里对游标进行定义*/  
 DECLARE  CONTINUE HANDLER FOR NOT FOUND  SET  no_more_products = 1; /*when "not found" occur,just continue,这个是个条件处理,针对NOT FOUND的条件*/  
  
 /* for  loggging information 创建个临时表格来保持*/  
 CREATE TEMPORARY TABLE infologs (  
 Id int(11) NOT NULL AUTO_INCREMENT,  
 Msg varchar(255) NOT NULL,  
 PRIMARY KEY (Id)  
 );  
  
 OPEN  cur_product; /*Second: Open the cursor 接着使用OPEN打开游标*/  
 FETCH  cur_product INTO prd_code; /*Third: now you can Fetch the row 把第一行数据写入变量中,游标也随之指向了记录的第一行*/  
  
 REPEAT  
  
 SELECT  quantity INTO quantity_in_stock  
 FROM  products  
 WHERE  code = prd_code;  
   
 IF  quantity_in_stock < 100 THEN  
 INSERT  INTO infologs(msg)  
 VALUES  (prd_code);  
 END  IF;  
 FETCH  cur_product INTO prd_code;  
  
 UNTIL  no_more_products = 1  
 END REPEAT;  
 CLOSE  cur_product;  /*Finally: cursor need be closed 用完后记得用CLOSE把资源释放掉*/  
 SELECT *  FROM infologs;  
 DROP TABLE  infologs;  
END $$  
  

DELIMITER ;  -- 恢复原来的分隔符为‘；’，不包含在存储过程中
```
